<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Delivery Order</title>

<style>
body{font-family:"Times New Roman",serif;background:#eaeaea;font-size:20px;}
.page{width:850px;background:#fff;margin:20px auto;padding:30px;}

.letterhead{text-align:center;font-size:22px;font-weight:bold;}
.subhead{text-align:center;font-size:14px;}

.header-row{display:table;width:100%;font-size:14px;margin-top:10px;}
.header-cell{display:table-cell;width:33.33%;padding:4px 0;vertical-align:middle;}
.left{text-align:left;}
.center{text-align:center;text-decoration:underline;}
.right{text-align:right;}

.contact-info { text-align:center; font-size:14px; margin:8px 0 12px 0; line-height:1.4; }

.hr{border-top:2px solid #000;margin:10px 0;}
.subject{text-align:center;font-weight:bold;font-size:16px;margin:10px 0;}

label{font-weight:bold; display:block; margin:12px 0 4px;}
.form input,.form select{
  width:100%;
  padding:6px;
  margin-bottom:8px;
  font-size:20px;
  box-sizing: border-box;
}

button{padding:10px 20px;font-size:16px;margin:5px;cursor:pointer;}

table{width:100%;border-collapse:collapse;font-size:20px;margin-top:10px;}
td,th{border:1px solid #000;padding:6px;}
.no-border td{border:none;padding:4px;}
.details-table td:first-child{font-weight:bold;width:30%;}

.box {
  display:inline-block;
  border:2px solid #000;
  padding:2px 8px;
  margin:0 4px;
  font-weight:bold;
}

#sugarLinesTable th, #sugarLinesTable td { padding:8px; text-align:center; }
#sugarLinesTable input { text-align:center; }

#output .output-letterhead {
  text-align:center;
  font-size:22px;
  font-weight:bold;
  color:#800000;
  margin-bottom:3px;
}
#output .output-subhead {
  text-align:center;
  font-size:15px;
  color:#333;
  margin-bottom:6px;
  font-weight: bold;
  text-decoration: underline;
}
#output .output-contact {
  text-align:center;
  font-size:14px;
  margin:4px 0 8px 0;
  line-height:1.3;
}
#output .header-band {
  background: linear-gradient(to bottom, #fdfd96, #f0e68c 70%, #fff);
  padding:8px 0;
  margin-bottom:10px;
}
#output .output-hr {
  border-top:2px double #800000;
  margin:12px 0;
}

#header-section.generated-hidden { display: none; }

.history-container {
  margin-top:30px;
  border:1px solid #aaa;
  padding:15px;
  background:#f9f9f9;
  max-height:400px;
  overflow-y:auto;
}

.history-item {
  padding:10px;
  border-bottom:1px solid #ddd;
  cursor:pointer;
}
.history-item:hover { background:#f0f8ff; }

@media print {
  @page { size: A4 portrait; margin: 0; }
  html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
  body { background: #fff !important; }
  .form, button, #historyViewer, #header-section { display: none !important; }
  #output {
    display: block !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    padding: 0mm 15mm 10mm 10mm;
    font-size: 15px;
    line-height: 1;
    width: 200mm;
    box-sizing: border-box;
  }
  table { font-size: 14px; table-layout: fixed; }
  .box { padding: 1px 5px; }
}
</style>
</head>
<body>
<div class="page">

<div id="header-section">
  <div class="letterhead">M/S P. P. DUNUNG AND COMPANY</div>
  <div class="subhead">Wholesale Sugar Dealers, Kolhapur</div>
  
  <div class="contact-info">
    1529 c ward Laxmipuri, Kolhapur<br>
    Phone No. 2642250 / 9271678091<br>
    Email: paragdunung@rediffmail.com
  </div>

  <div class="header-row">
    <div class="header-cell left"><b>GSTN:</b> 27AAYPD2686B1ZI</div>
    <div class="header-cell center">Subject to Kolhapur Jurisdiction</div>
    <div class="header-cell right"><b>FSSAI:</b> 11522042000172</div>
  </div>

  <div class="hr"></div>
  <div class="subject">Sub: DELIVERY OF FREE SALE SUGAR</div>
</div>

<div class="form">

<label>DO Number</label>
<input id="dono">

<label>Managing Director Name</label>
<input id="mdname" list="mdnameList">
<datalist id="mdnameList"></datalist>

<label>Managing Director Address</label>
<input id="mdaddress" list="mdaddrList">
<datalist id="mdaddrList"></datalist>

<div style="margin:20px 0;">
  <label style="font-size:22px;">Sugar Details (Multiple Grades Allowed)</label>
  
  <table id="sugarLinesTable">
    <thead>
      <tr style="background:#f8f8f8;">
        <th>Quantity (Quintal)</th>
        <th>Sugar Grade</th>
        <th>Tender Rate (₹)</th>
        <th>Effective Qty</th>
        <th>Rate + 5% GST</th>
        <th>Total Value + GST</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="sugarLinesBody"></tbody>
  </table>

  <button type="button" onclick="addSugarLine()" style="background:#4CAF50;color:white;border:none;padding:10px 16px;margin-top:8px;">
    + Add Sugar Grade / Line
  </button>
</div>

<label>Total Bags</label>
<input id="eqty" readonly>

<label>Grand Total Value With GST</label>
<input id="totalgst" readonly>

<label>Less TDS @0.10%</label>
<input id="tds" readonly>

<label>Final Total Payable</label>
<input id="finaltotal" readonly style="font-weight:bold;font-size:24px;">

<label>Truck No</label>
<input id="truck">

<label>Bank Name</label>
<input id="bank" list="bankList">
<datalist id="bankList"></datalist>

<label>RTGS No.</label>
<input id="rtgs">

<label>Bill To</label>
<input id="billto" list="billtoList">
<datalist id="billtoList"></datalist>

<label>GST No. (Bill To)</label>
<input id="billgst" list="billgstList">
<datalist id="billgstList"></datalist>

<label>Shipped To</label>
<input id="shipto" list="shiptoList">
<datalist id="shiptoList"></datalist>

<label>GST No. (Shipped To)</label>
<input id="shipgst" list="shipgstList">
<datalist id="shipgstList"></datalist>

<br><br>

<button onclick="generateDO()" style="background:#0066cc;color:white;">Generate DO</button>
<button onclick="generateAttachmentLetter()" style="background:#8B4513;color:white;">Generate Attachment Letter</button>
<button onclick="window.print()" style="background:#2E8B57;color:white;">Print / Save PDF</button>
<button onclick="newDO()" style="background:#9932CC;color:white;">New DO</button>

<!-- ─── NEW BUTTONS ─────────────────────────────────────── -->
<button onclick="exportDailyBackup()" style="background:#e67e22;color:white;">Daily Backup (Today)</button>
<button onclick="showHistory()" style="background:#7f8c8d;color:white;">View & Print Old DOs</button>
<button onclick="showOldVoucherSelector()" style="background:#e74c3c;color:white;">
  Old Daily Voucher
</button>

<button onclick="showOldAttachmentSelector()" style="background:#d35400;color:white;">
  Old Attachment Letter
</button>
<br><br>

<label>Report Type:</label>
<select id="reportType">
  <option value="current">Current DO</option>
  <option value="daily">Daily</option>
  <option value="weekly">Weekly</option>
  <option value="monthly">Monthly</option>
  <option value="custom">Custom</option>
</select>
<div id="customDates" style="display:none;">
  <label>From Date (dd/mm/yyyy):</label><input id="fromDate" type="text" placeholder="01/01/2026">
  <label>To Date (dd/mm/yyyy):</label><input id="toDate" type="text" placeholder="31/01/2026">
</div>
<button onclick="exportReport()" style="background:#FF4500;color:white;">Export Report to CSV</button>
<button onclick="generateDailyVoucher()" style="background:#27ae60;color:white;">Generate Daily Voucher</button>

</div>

<div id="output"></div>

<!-- ─── HISTORY VIEWER ─────────────────────────────────── -->
<div id="historyViewer" class="history-container" style="display:none;">
  <h3 style="margin-top:0;">Previous Delivery Orders</h3>
  <div id="historyList"></div>
  <br>
  <button onclick="document.getElementById('historyViewer').style.display='none'">Close History</button>
</div>

</div>

<script>
// ────────────────────────────────────────────────
//                  BASIC SETUP & STORAGE
// ────────────────────────────────────────────────
let lastDO = localStorage.getItem("lastDO") || 125;
lastDO = Number(lastDO) + 1;
document.getElementById('dono').value = "DO/2026/" + lastDO;

function saveDONumber(){
  let num = document.getElementById('dono').value.split("/").pop();
  localStorage.setItem("lastDO", num);
}

function generateNewDONumber() {
  let lastDO = localStorage.getItem("lastDO") || 125;
  lastDO = Number(lastDO) + 1;
  localStorage.setItem("lastDO", lastDO);
  document.getElementById('dono').value = "DO/2026/" + lastDO;
}

// Autosuggest
function saveArray(key,value){
  if(!value) return;
  let arr = JSON.parse(localStorage.getItem(key) || "[]");
  if(!arr.includes(value)) arr.push(value);
  localStorage.setItem(key, JSON.stringify(arr));
}
function loadArray(key,listId){
  let arr = JSON.parse(localStorage.getItem(key) || "[]");
  let dl = document.getElementById(listId);
  dl.innerHTML="";
  arr.forEach(v=>{
    let o=document.createElement("option");
    o.value=v;
    dl.appendChild(o);
  });
}

loadArray("mdnameArr","mdnameList");
loadArray("mdaddrArr","mdaddrList");
loadArray("bankArr","bankList");
loadArray("billtoArr","billtoList");
loadArray("billgstArr","billgstList");
loadArray("shiptoArr","shiptoList");
loadArray("shipgstArr","shipgstList");

// ────────────────────────────────────────────────
//               MULTI-LINE CALCULATION
// ────────────────────────────────────────────────
let sugarLines = [];

function addSugarLine(qty='',grade='',rate='') {
  const id = Date.now();
  sugarLines.push({id});

  const tbody = document.getElementById('sugarLinesBody');
  const tr = document.createElement('tr');
  tr.id = `line-${id}`;
  tr.innerHTML = `
    <td><input type="number" class="line-qty"   value="${qty}"></td>
    <td><input type="text"   class="line-grade" value="${grade}"></td>
    <td><input type="number" class="line-rate"  value="${rate}"></td>
    <td><input type="text"   class="line-eqty"  readonly></td>
    <td><input type="text"   class="line-gst"   readonly></td>
    <td><input type="text"   class="line-total" readonly></td>
    <td><button type="button" onclick="removeLine(${id})" style="background:#e74c3c;color:white;border:none;padding:6px 10px;cursor:pointer;">×</button></td>
  `;
  tbody.appendChild(tr);

  tr.querySelectorAll('input:not([readonly])').forEach(el => {
    el.addEventListener('input', updateCalculations);
  });

  updateCalculations();
}

function removeLine(id) {
  sugarLines = sugarLines.filter(l => l.id !== id);
  document.getElementById(`line-${id}`).remove();
  updateCalculations();
}

function updateCalculations() {
  let grandEffQty = 0;
  let grandTotalWithGst = 0;
  let grandBaseValue = 0;

  document.querySelectorAll('#sugarLinesBody tr').forEach(row => {
    const qty  = Number(row.querySelector('.line-qty').value)  || 0;
    const rate = Number(row.querySelector('.line-rate').value) || 0;

    const effQty       = qty * 2;
    const rateWithGst  = Math.round(rate * 1.05);
    const lineTotalGst = Math.round(rateWithGst * qty);

    row.querySelector('.line-eqty').value  = effQty;
    row.querySelector('.line-gst').value   = rateWithGst;
    row.querySelector('.line-total').value = lineTotalGst;

    grandEffQty       += effQty;
    grandTotalWithGst += lineTotalGst;
    grandBaseValue    += qty * rate;
  });

  const tdsAmount = Math.round(grandBaseValue * 0.001);
  const finalTotal = Math.round(grandTotalWithGst - tdsAmount);

  document.getElementById('eqty').value     = grandEffQty;
  document.getElementById('totalgst').value = grandTotalWithGst;
  document.getElementById('tds').value      = tdsAmount;
  document.getElementById('finaltotal').value = finalTotal;
}

// Initialize with one line + some mill names
window.addEventListener('load', () => {
const millNames = [
"Chh Rajaram S S K Ltd","Dudhganga S S K Ltd","D H GAIKWAD","ADITI SUGARS",
"CHAMUNDESHWARI ENTERPRISES","AASHIRWAD SUGARS","Shri Bhogavati S S K Ltd",
"Kumbhi-Kasari S S K Ltd","HALSIDDHANATH SSK LTD","VISHWASRAO NAIK SSK LTD",
"MAHALAXMI ENTERPRISES","KALPANA TRADERS","NTEX TRANSPORTATION PVT LTD",
"SHRI SHAHU SSK LTD KAGAL","S M KAGAL TAL SSK LTD",
"M/s DALMIA BHARAT SUGAR & INDUSTRIES","TIRUPATI TRADING","RONAK TRADERS",
"RENUKA SUGARS WORK LTD, ICHALKARANJI",
"SINDHUDURG DIS.CEN.CO-OP BANK LTD.,SINDUDURGNAGRI     A/C PAD.DR.D.Y.PATIL S S S K LTD",
"JAWAHAR SSK LTD","VISION 2E","VENKATESHWARA POWER LTD",
"DOUBLE ROUTE MULTITRADE PVT  LTD","SHAH BALMUKUND TULSIDAS AND COMPANY",
"VASANTRAO DESAI AJARA SHETKARI SAHAKARI SAKHAR  KARKHANA LIMITED",
"SHARAD SAKHAR KARKHANA SSK","Shri Mahalaxmi Narayani Sugars.",
"SHREE DATTA SHETAKRI SSSK LTD","MAHALAXMI ENTERPRISES"
];

let arr = JSON.parse(localStorage.getItem("mdnameArr") || "[]");
millNames.forEach(name => {
  if(!arr.includes(name)) arr.push(name);
});
localStorage.setItem("mdnameArr", JSON.stringify(arr));
loadArray("mdnameArr","mdnameList");

document.getElementById('mdname').addEventListener('change', () => {
  document.getElementById('mdaddress').value = 'Kolhapur';
});

document.getElementById('reportType').addEventListener('change', function() {
  document.getElementById('customDates').style.display = this.value === 'custom' ? 'block' : 'none';
});

addSugarLine();
});

// ────────────────────────────────────────────────
//                   UTILITIES
// ────────────────────────────────────────────────
function today(){
  const d = new Date();
  return String(d.getDate()).padStart(2,"0")+"/"+String(d.getMonth()+1).padStart(2,"0")+"/"+d.getFullYear();
}

function newDO(){
  generateNewDONumber();
  document.querySelectorAll(".form input:not(#dono)").forEach(el=>el.value="");
  document.getElementById('sugarLinesBody').innerHTML = '';
  sugarLines = [];
  addSugarLine();
  updateCalculations();
  document.getElementById('output').innerHTML="";
  document.getElementById('header-section').classList.remove('generated-hidden');
  document.getElementById('historyViewer').style.display = 'none';
}

// ────────────────────────────────────────────────
//                  GENERATE DO - IMPROVED TABLE
// ────────────────────────────────────────────────
function generateDO(){
  saveDONumber();

  saveArray("mdnameArr", document.getElementById('mdname').value);
  saveArray("mdaddrArr", document.getElementById('mdaddress').value);
  saveArray("bankArr", document.getElementById('bank').value);
  saveArray("billtoArr", document.getElementById('billto').value);
  saveArray("billgstArr", document.getElementById('billgst').value);
  saveArray("shiptoArr", document.getElementById('shipto').value);
  saveArray("shipgstArr", document.getElementById('shipgst').value);

  saveDOData();

  document.getElementById('header-section').classList.add('generated-hidden');

  const truck = document.getElementById('truck').value || '-';
  const grandEffQty = document.getElementById('eqty').value || '0';

  let linesHtml = '';
  document.querySelectorAll('#sugarLinesBody tr').forEach(row => {
    const qty   = row.querySelector('.line-qty').value   || '0';
    const grade = row.querySelector('.line-grade').value || '-';
    linesHtml += `<span class="box">• ${qty} Quintals </span> of Grade <span class="box">${grade}</span><br>`;
  });

  document.getElementById('output').innerHTML = `
<div class="header-band">
  <div class="header-row" style="color:#0033cc; margin-bottom:6px; font-size:12px;">
    <div class="header-cell left"><b>GSTN:</b> 27AAYPD2686B1ZI</div>
    <div class="header-cell center">Subject to Kolhapur Jurisdiction</div>
    <div class="header-cell right"><b>FSSAI:</b> 11522042000172</div>
  </div>
  <div class="output-letterhead">M/S P. P. DUNUNG AND COMPANY</div>
  <div class="output-subhead">Wholesale Sugar Dealers, Kolhapur</div>
  <div class="output-contact">
    1529 c ward Laxmipuri, Kolhapur. Phone No. 2642250 / 9271678091<br>
    Email: paragdunung@rediffmail.com
  </div>
</div>

<div class="output-hr"></div>
<div style="text-align:center;font-weight:bold;font-size:18px;margin:15px 0;">DELIVERY ORDER</div>

<table class="no-border" style="margin-bottom:15px;">
  <tr>
    <td><b>DO No:</b> ${document.getElementById('dono').value}</td>
    <td style="text-align:right"><b>Date:</b> ${today()}</td>
  </tr>
</table>

<p><b>To,</b><br>
Managing Director,<br>
${document.getElementById('mdname').value || '---'}<br>
${document.getElementById('mdaddress').value || '---'}</p>

<p><b>Sub:</b> <span style="font-weight:bold; text-decoration:underline;">DELIVERY OF FREE SALE SUGAR</span></p>

<p>Respected Sir,</p>

<p>Please deliver the following free sale sugar through Truck No. <span class="box">${truck}</span>:</p>
<p style="margin-left:25px; margin-bottom:12px;">${linesHtml || '<i>No grades entered</i>'}</p>

<p style="font-size:17px; margin:15px 0; font-weight:bold;">
  Total Bags: <span class="box">${grandEffQty}</span>
</p>

<table style="font-size:15px; margin:12px 0; border:1px solid #666; width:70%;">
  <tr style="background:#f8f8f8;">
    <td style="padding:6px 8px; border-right:1px solid #666;">Total Value With GST</td>
    <td style="padding:6px 8px;">Rs. ${document.getElementById('totalgst').value || '0'}</td>
  </tr>
  <tr>
    <td style="padding:6px 8px; border-right:1px solid #666;">Less TDS @0.10%</td>
    <td style="padding:6px 8px;">Rs. ${document.getElementById('tds').value || '0'}</td>
  </tr>
  <tr style="font-weight:bold; background:#f0f0f0;">
    <td style="padding:8px 8px; border-right:1px solid #666;">Total Payable</td>
    <td style="padding:8px 8px;">Rs. ${document.getElementById('finaltotal').value || '0'}</td>
  </tr>
</table>

<table class="details-table" style="margin-top:25px; font-size:15px;">
  <tr><td>Bank Name</td><td>${document.getElementById('bank').value || '-'}</td></tr>
  <tr><td>RTGS No.</td><td>${document.getElementById('rtgs').value || '-'}</td></tr>
  <tr><td>Bill To</td><td>${document.getElementById('billto').value || '-'}</td></tr>
  <tr><td>GST No. (Bill To)</td><td>${document.getElementById('billgst').value || '-'}</td></tr>
  <tr><td>Shipped To</td><td>${document.getElementById('shipto').value || '-'}</td></tr>
  <tr><td>GST No. (Shipped To)</td><td>${document.getElementById('shipgst').value || '-'}</td></tr>
</table>

<p style="margin-top:45px;">Yours faithfully,<br><br>
<div style="position:relative; height:100px;">
  <div style="position:absolute; left:0; bottom:0;">
    <img src="Stamp.png" alt="Company Stamp" style="width:140px; height:auto; opacity:0.9;">
  </div>
</div>
Authorized Signatory</p>`;
}

// ────────────────────────────────────────────────
//              GENERATE ATTACHMENT LETTER
// ────────────────────────────────────────────────
function generateAttachmentLetter(){
  saveDONumber();

  saveArray("mdnameArr", document.getElementById('mdname').value);
  saveArray("mdaddrArr", document.getElementById('mdaddress').value);
  saveArray("bankArr", document.getElementById('bank').value);
  saveArray("billtoArr", document.getElementById('billto').value);
  saveArray("billgstArr", document.getElementById('billgst').value);
  saveArray("shiptoArr", document.getElementById('shipto').value);
  saveArray("shipgstArr", document.getElementById('shipgst').value);

  document.getElementById('header-section').classList.add('generated-hidden');

  const finalTotal = document.getElementById('finaltotal').value || '0';
  const rtgsNo = document.getElementById('rtgs').value || '-';

  document.getElementById('output').innerHTML = `
<div class="header-band">
  <div class="header-row" style="color:#0033cc; margin-bottom:6px; font-size:12px;">
    <div class="header-cell left"><b>GSTN:</b> 27AAYPD2686B1ZI</div>
    <div class="header-cell center">Subject to Kolhapur Jurisdiction</div>
    <div class="header-cell right"><b>FSSAI:</b> 11522042000172</div>
  </div>

  <div class="output-letterhead">M/S P. P. DUNUNG AND COMPANY</div>
  <div class="output-subhead">Wholesale Sugar Dealers, Kolhapur</div>

  <div class="output-contact">
    1529 c ward Laxmipuri, Kolhapur. Phone No. 2642250 / 9271678091<br>
    Email: paragdunung@rediffmail.com
  </div>
</div>

<div class="output-hr"></div>

<table class="no-border" style="margin-bottom:20px;">
  <tr>
    <td></td>
    <td style="text-align:right"><b>दिनांक :</b> ${today()}</td>
  </tr>
</table>

<p><b>प्रति,</b><br>
${document.getElementById('mdname').value || '---'}<br>
${document.getElementById('mdaddress').value || '---'}</p>

<p><b>विषय :</b> रक्कम जमा करणेबाबत</p>

<p>महोदय,</p>

<p>आपले खातेवर RTGS Rs. <span class="box">${finalTotal}</span> खालील प्रमाणे जमा करणे बाबत</p>

<p>1) M/S P. P. DUNUNG AND COMPANY KOLHAPUR<br>
<span style="display:inline-block; margin-left:40px;">रक्कम Rs. <span class="box">${finalTotal}</span></span><br>
<span style="display:inline-block; margin-left:40px;">RTGS No. <span class="box">${rtgsNo}</span></span></p>

<p style="margin-top:50px;">Yours faithfully,<br><br>
<div style="position:relative; height:100px;">
  <div style="position:absolute; left:0; bottom:0;">
    <img src="Stamp.png" alt="Company Stamp" style="width:140px; height:auto; opacity:0.9;">
  </div>
</div>
Authorized Signatory</p>`;
}

// ────────────────────────────────────────────────
//          DATA MANAGEMENT & HISTORY
// ────────────────────────────────────────────────
function getCurrentDOData() {
  const data = {
    date: today(),
    timestamp: new Date().toISOString(),
    doNumber: document.getElementById('dono').value,
    mdName: document.getElementById('mdname').value,
    mdAddress: document.getElementById('mdaddress').value,
    sugarLines: [],
    effectiveTotalBags: document.getElementById('eqty').value,
    totalValueGst: document.getElementById('totalgst').value,
    lessTds: document.getElementById('tds').value,
    finalTotal: document.getElementById('finaltotal').value,
    truckNo: document.getElementById('truck').value,
    bankName: document.getElementById('bank').value,
    rtgsNo: document.getElementById('rtgs').value,
    billTo: document.getElementById('billto').value,
    billGst: document.getElementById('billgst').value,
    shipTo: document.getElementById('shipto').value,
    shipGst: document.getElementById('shipgst').value
  };
  document.querySelectorAll('#sugarLinesBody tr').forEach(row => {
    data.sugarLines.push({
      quintal: row.querySelector('.line-qty').value || '',
      grade: row.querySelector('.line-grade').value || '',
      tenderRate: row.querySelector('.line-rate').value || '',
      effectiveBags: row.querySelector('.line-eqty').value || '',
      rateGst: row.querySelector('.line-gst').value || '',
      totalGst: row.querySelector('.line-total').value || ''
    });
  });
  return data;
}

function saveDOData() {
  const doData = getCurrentDOData();
  if (!doData.doNumber || !doData.mdName.trim()) return;
  
  let allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  // Prevent duplicate by doNumber
  allDOs = allDOs.filter(d => d.doNumber !== doData.doNumber);
  allDOs.push(doData);
  localStorage.setItem("allDOs", JSON.stringify(allDOs));
}

function exportDailyBackup() {
  const todayStr = today();
  let allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  const todayDOs = allDOs.filter(d => d.date === todayStr);

  if (todayDOs.length === 0) return alert("No DOs found for today!");

  let csv = "DATE,DO NUMBER,MD Name,MD Address,Quintal,Grade,Rate,Effective Bags,Rate+GST,Line Total GST,Total Bags,Total GST Value,TDS,Final Total,Truck,Bank,RTGS,Bill To,Bill GST,Ship To,Ship GST\n";

  todayDOs.forEach(doItem => {
    if (doItem.sugarLines.length === 0) {
      csv += `"${doItem.date}","${doItem.doNumber}","${doItem.mdName}","${doItem.mdAddress}",,,,,,"${doItem.effectiveTotalBags}","${doItem.totalValueGst}","${doItem.lessTds}","${doItem.finalTotal}","${doItem.truckNo}","${doItem.bankName}","${doItem.rtgsNo}","${doItem.billTo}","${doItem.billGst}","${doItem.shipTo}","${doItem.shipGst}"\n`;
    } else {
      doItem.sugarLines.forEach(line => {
        csv += `"${doItem.date}","${doItem.doNumber}","${doItem.mdName}","${doItem.mdAddress}","${line.quintal}","${line.grade}","${line.tenderRate}","${line.effectiveBags}","${line.rateGst}","${line.totalGst}","${doItem.effectiveTotalBags}","${doItem.totalValueGst}","${doItem.lessTds}","${doItem.finalTotal}","${doItem.truckNo}","${doItem.bankName}","${doItem.rtgsNo}","${doItem.billTo}","${doItem.billGst}","${doItem.shipTo}","${doItem.shipGst}"\n`;
      });
    }
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `Daily_Backup_${todayStr.replace(/\//g,'-')}.csv`;
  link.click();
}

// ────────────────────────────────────────────────
//               OLD DO PRINT / VIEW
// ────────────────────────────────────────────────
function showHistory() {
  const viewer = document.getElementById('historyViewer');
  const list = document.getElementById('historyList');
  list.innerHTML = '';

  let allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  if (allDOs.length === 0) {
    list.innerHTML = "<p>No previous DOs found.</p>";
    viewer.style.display = 'block';
    return;
  }

  // Group by date
  const groups = {};
  allDOs.forEach(d => {
    if (!groups[d.date]) groups[d.date] = [];
    groups[d.date].push(d);
  });

  Object.keys(groups).sort((a,b)=> {
    const da = a.split('/').reverse().join('');
    const db = b.split('/').reverse().join('');
    return db.localeCompare(da);
  }).forEach(date => {
    const div = document.createElement('div');
    div.innerHTML = `<strong>${date}</strong> (${groups[date].length} DOs)<br>`;
    
    groups[date].forEach(doItem => {
      const item = document.createElement('div');
      item.className = 'history-item';
      item.innerHTML = `DO ${doItem.doNumber} - ${doItem.mdName.substring(0,35)}${doItem.mdName.length>35?'...':''}`;
      item.onclick = () => loadOldDO(doItem);
      div.appendChild(item);
    });
    
    list.appendChild(div);
  });

  viewer.style.display = 'block';
}

function loadOldDO(doData) {
  document.getElementById('output').innerHTML = '';

  let linesHtml = '';
  doData.sugarLines.forEach(line => {
    linesHtml += `<span class="box">• ${line.quintal} Quintals </span> of Grade <span class="box">${line.grade}</span><br>`;
  });

  document.getElementById('output').innerHTML = `
<div class="header-band">
  <div class="header-row" style="color:#0033cc; margin-bottom:6px; font-size:12px;">
    <div class="header-cell left"><b>GSTN:</b> 27AAYPD2686B1ZI</div>
    <div class="header-cell center">Subject to Kolhapur Jurisdiction</div>
    <div class="header-cell right"><b>FSSAI:</b> 11522042000172</div>
  </div>
  <div class="output-letterhead">M/S P. P. DUNUNG AND COMPANY</div>
  <div class="output-subhead">Wholesale Sugar Dealers, Kolhapur</div>
  <div class="output-contact">
    1529 c ward Laxmipuri, Kolhapur. Phone No. 2642250 / 9271678091<br>
    Email: paragdunung@rediffmail.com
  </div>
</div>

<div class="output-hr"></div>
<div style="text-align:center;font-weight:bold;font-size:18px;margin:15px 0;">DELIVERY ORDER (OLD / BACKDATED)</div>

<table class="no-border" style="margin-bottom:15px;">
  <tr>
    <td><b>DO No:</b> ${doData.doNumber}</td>
    <td style="text-align:right"><b>Date:</b> ${doData.date}</td>
  </tr>
</table>

<p><b>To,</b><br>
Managing Director,<br>
${doData.mdName || '---'}<br>
${doData.mdAddress || '---'}</p>

<p><b>Sub:</b> <span style="font-weight:bold; text-decoration:underline;">DELIVERY OF FREE SALE SUGAR</span></p>

<p>Respected Sir,</p>

<p>Please deliver the following free sale sugar through Truck No. <span class="box">${doData.truckNo || '-'}</span>:</p>
<p style="margin-left:25px; margin-bottom:12px;">${linesHtml || '<i>No grades entered</i>'}</p>

<p style="font-size:17px; margin:15px 0; font-weight:bold;">
   Total Bags: <span class="box">${doData.effectiveTotalBags || '0'}</span>
</p>

<table style="font-size:15px; margin:12px 0; border:1px solid #666; width:70%;">
  <tr style="background:#f8f8f8;">
    <td style="padding:6px 8px; border-right:1px solid #666;">Total Value With GST</td>
    <td style="padding:6px 8px;">Rs. ${doData.totalValueGst || '0'}</td>
  </tr>
  <tr>
    <td style="padding:6px 8px; border-right:1px solid #666;">Less TDS @0.10%</td>
    <td style="padding:6px 8px;">Rs. ${doData.lessTds || '0'}</td>
  </tr>
  <tr style="font-weight:bold; background:#f0f0f0;">
    <td style="padding:8px 8px; border-right:1px solid #666;">Total Payable</td>
    <td style="padding:8px 8px;">Rs. ${doData.finalTotal || '0'}</td>
  </tr>
</table>

<table class="details-table" style="margin-top:25px; font-size:15px;">
  <tr><td>Bank Name</td><td>${doData.bankName || '-'}</td></tr>
  <tr><td>RTGS No.</td><td>${doData.rtgsNo || '-'}</td></tr>
  <tr><td>Bill To</td><td>${doData.billTo || '-'}</td></tr>
  <tr><td>GST No. (Bill To)</td><td>${doData.billGst || '-'}</td></tr>
  <tr><td>Shipped To</td><td>${doData.shipTo || '-'}</td></tr>
  <tr><td>GST No. (Shipped To)</td><td>${doData.shipGst || '-'}</td></tr>
</table>

<p style="margin-top:45px;">Yours faithfully,<br><br>
<div style="position:relative; height:100px;">
  <div style="position:absolute; left:0; bottom:0;">
    <img src="Stamp.png" alt="Company Stamp" style="width:140px; height:auto; opacity:0.9;">
  </div>
</div>
Authorized Signatory</p>`;

  document.getElementById('historyViewer').style.display = 'none';
  window.scrollTo(0, document.getElementById('output').offsetTop - 100);
}

// ────────────────────────────────────────────────
//                 REPORT EXPORT
// ────────────────────────────────────────────────
function exportReport() {
  const reportType = document.getElementById('reportType').value;
  let allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  let filteredDOs = [];
  const now = new Date();
  let from, to;

  function parseDate(str) {
    if (!str) return null;
    const [d, m, y] = str.split('/');
    return new Date(y, m - 1, d);
  }

  if (reportType === 'current') {
    const current = getCurrentDOData();
    if (!current.doNumber || !current.mdName.trim()) return alert('No valid current DO data');
    filteredDOs = [current];
  } else {
    allDOs = allDOs.filter(doItem => doItem.doNumber && doItem.mdName.trim());
    if (reportType === 'daily') {
      from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      to = new Date(from);
      to.setDate(to.getDate() + 1);
    } else if (reportType === 'weekly') {
      from = new Date(now);
      from.setDate(from.getDate() - from.getDay());
      to = new Date(from);
      to.setDate(to.getDate() + 7);
    } else if (reportType === 'monthly') {
      from = new Date(now.getFullYear(), now.getMonth(), 1);
      to = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    } else if (reportType === 'custom') {
      const fromStr = document.getElementById('fromDate').value;
      const toStr = document.getElementById('toDate').value;
      if (!fromStr || !toStr) return alert('Please enter dates');
      from = parseDate(fromStr);
      to = parseDate(toStr);
      if (!from || !to) return alert('Invalid date format');
      to.setDate(to.getDate() + 1);
    }
    filteredDOs = allDOs.filter(doItem => {
      const doDate = parseDate(doItem.date);
      return doDate && doDate >= from && doDate < to;
    });
  }

  if (filteredDOs.length === 0) return alert('No data for selected period');

  let csv = 'DATE,DO NUMBER,Managing Director Name,Managing Director ADDRESS,Quintal,Grade,Tender Rate (₹),Effective Bags,Rate + 5% GST,Total Value + GST,Effective Total Bags,Total Value With GST,Less TDS @0.10%,Final Total Payable,Truck No.,Bank Name,RTGS No.,Bill To,GST No. (Bill To),Shipped To,GST No. (Shipped To)\n';

  filteredDOs.forEach(doItem => {
    if (doItem.sugarLines.length === 0) {
      csv += `"${doItem.date || ''}","${doItem.doNumber || ''}","${doItem.mdName || ''}","${doItem.mdAddress || ''}",,,,,,"${doItem.effectiveTotalBags || ''}","${doItem.totalValueGst || ''}","${doItem.lessTds || ''}","${doItem.finalTotal || ''}","${doItem.truckNo || ''}","${doItem.bankName || ''}","${doItem.rtgsNo || ''}","${doItem.billTo || ''}","${doItem.billGst || ''}","${doItem.shipTo || ''}","${doItem.shipGst || ''}"\n`;
    } else {
      doItem.sugarLines.forEach(line => {
        csv += `"${doItem.date || ''}","${doItem.doNumber || ''}","${doItem.mdName || ''}","${doItem.mdAddress || ''}","${line.quintal || ''}","${line.grade || ''}","${line.tenderRate || ''}","${line.effectiveBags || ''}","${line.rateGst || ''}","${line.totalGst || ''}","${doItem.effectiveTotalBags || ''}","${doItem.totalValueGst || ''}","${doItem.lessTds || ''}","${doItem.finalTotal || ''}","${doItem.truckNo || ''}","${doItem.bankName || ''}","${doItem.rtgsNo || ''}","${doItem.billTo || ''}","${doItem.billGst || ''}","${doItem.shipTo || ''}","${doItem.shipGst || ''}"\n`;
      });
    }
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `DO_Report_${reportType}_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
}

// ────────────────────────────────────────────────
//          DAILY VOUCHER - SINGLE CURRENT DO ONLY
// ────────────────────────────────────────────────
function generateDailyVoucher() {
  const currentDO = getCurrentDOData();

  // Basic validation - check if we have meaningful data
  if (!currentDO.doNumber || !currentDO.mdName.trim() || 
      !currentDO.finalTotal || currentDO.finalTotal === '0') {
    return alert("Please generate a valid DO first!\n(No DO number, MD name or amount found)");
  }

  const finalVal = Number(currentDO.finalTotal || 0);
  const tdsVal   = Number(currentDO.lessTds || 0);

  let voucherHtml = `
<div class="header-band">
  <div class="output-letterhead">M/S P. P. DUNUNG AND COMPANY</div>
  <div class="output-subhead">DAILY VOUCHER </div>
  <div style="text-align:center; font-size:14px; margin:8px 0;">
    Date: ${currentDO.date} &nbsp;&nbsp;|&nbsp;&nbsp; DO No: ${currentDO.doNumber}
  </div>
</div>

<div class="output-hr"></div>

<table style="width:100%; font-size:15px; margin:20px 0; border-collapse: collapse;">
  <tr style="background:#f8f8f8;">
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold; width:35%;">Mill / Managing Director</td>
    <td style="padding:10px; border:1px solid #ccc;">${currentDO.mdName}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Effective Bags</td>
    <td style="padding:10px; border:1px solid #ccc;">${currentDO.effectiveTotalBags || '0'}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Truck No.</td>
    <td style="padding:10px; border:1px solid #ccc;">${currentDO.truckNo || '-'}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Bank Name</td>
    <td style="padding:10px; border:1px solid #ccc;">${currentDO.bankName || '-'}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">RTGS No.</td>
    <td style="padding:10px; border:1px solid #ccc;">${currentDO.rtgsNo || '-'}</td>
  </tr>
  <tr style="background:#fff3cd;">
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Total Value With GST</td>
    <td style="padding:10px; border:1px solid #ccc;">₹ ${Number(currentDO.totalValueGst || 0).toLocaleString('en-IN')}</td>
  </tr>
  <tr style="background:#fff3cd;">
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Less TDS @0.10%</td>
    <td style="padding:10px; border:1px solid #ccc;">₹ ${tdsVal.toLocaleString('en-IN')}</td>
  </tr>
  <tr style="font-weight:bold; background:#d4edda; font-size:17px;">
    <td style="padding:12px; border:1px solid #ccc; text-align:right;">FINAL PAYABLE AMOUNT :</td>
    <td style="padding:12px; border:1px solid #ccc;">₹ ${finalVal.toLocaleString('en-IN')}</td>
  </tr>
</table>

<p style="margin-top:50px; text-align:center; font-size:15px;">
  Payment to be made via RTGS as per above details.<br><br>
  Prepared by: ___________________ &nbsp;&nbsp;&nbsp; 
  Checked by: ___________________ &nbsp;&nbsp;&nbsp; 
  Authorized Signatory: ___________________
</p>`;

  document.getElementById('output').innerHTML = voucherHtml;
  window.scrollTo(0, document.getElementById('output').offsetTop - 100);
}
// ────────────────────────────────────────────────
//     SELECT & PRINT OLD SINGLE DO VOUCHER
// ────────────────────────────────────────────────
function showOldVoucherSelector() {
  const allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  if (allDOs.length === 0) {
    return alert("No previous DOs found in history.");
  }

  let html = `
    <h3 style="margin:0 0 15px 0;">Select DO for Voucher</h3>
    <div style="max-height:350px; overflow-y:auto; border:1px solid #ccc; padding:10px; background:#f9f9f9;">
  `;

  // Sort by date descending (newest first)
  allDOs.sort((a,b) => {
    const dateA = a.date.split('/').reverse().join('');
    const dateB = b.date.split('/').reverse().join('');
    return dateB.localeCompare(dateA);
  });

  allDOs.forEach(doItem => {
    if (!doItem.doNumber || !doItem.mdName.trim()) return;
    html += `
      <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;"
           onclick="generateOldVoucher('${doItem.doNumber}')">
        ${doItem.date} • ${doItem.doNumber} • ${doItem.mdName.substring(0,45)}${doItem.mdName.length>45?'...':''}
      </div>
    `;
  });

  html += `</div><br><button onclick="document.getElementById('historyViewer').style.display='none'">Close</button>`;

  document.getElementById('historyList').innerHTML = html;
  document.getElementById('historyViewer').style.display = 'block';
}

function generateOldVoucher(doNumber) {
  const allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  const doData = allDOs.find(d => d.doNumber === doNumber);
  
  if (!doData) return alert("Selected DO not found.");

  const finalVal = Number(doData.finalTotal || 0);
  const tdsVal   = Number(doData.lessTds || 0);

  let voucherHtml = `
<div class="header-band">
  <div class="output-letterhead">M/S P. P. DUNUNG AND COMPANY</div>
  <div class="output-subhead">Payment Voucher - Single DO (Historical)</div>
  <div style="text-align:center; font-size:14px; margin:8px 0;">
    Date: ${doData.date} &nbsp;&nbsp;|&nbsp;&nbsp; DO No: ${doData.doNumber}
  </div>
</div>

<div class="output-hr"></div>

<table style="width:100%; font-size:15px; margin:20px 0; border-collapse: collapse;">
  <tr style="background:#f8f8f8;">
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold; width:35%;">Mill / Managing Director</td>
    <td style="padding:10px; border:1px solid #ccc;">${doData.mdName}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Total Bags</td>
    <td style="padding:10px; border:1px solid #ccc;">${doData.effectiveTotalBags || '0'}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Truck No.</td>
    <td style="padding:10px; border:1px solid #ccc;">${doData.truckNo || '-'}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Bank Name</td>
    <td style="padding:10px; border:1px solid #ccc;">${doData.bankName || '-'}</td>
  </tr>
  <tr>
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">RTGS No.</td>
    <td style="padding:10px; border:1px solid #ccc;">${doData.rtgsNo || '-'}</td>
  </tr>
  <tr style="background:#fff3cd;">
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Total Value With GST</td>
    <td style="padding:10px; border:1px solid #ccc;">₹ ${Number(doData.totalValueGst || 0).toLocaleString('en-IN')}</td>
  </tr>
  <tr style="background:#fff3cd;">
    <td style="padding:10px; border:1px solid #ccc; font-weight:bold;">Less TDS @0.10%</td>
    <td style="padding:10px; border:1px solid #ccc;">₹ ${tdsVal.toLocaleString('en-IN')}</td>
  </tr>
  <tr style="font-weight:bold; background:#d4edda; font-size:17px;">
    <td style="padding:12px; border:1px solid #ccc; text-align:right;">FINAL PAYABLE AMOUNT :</td>
    <td style="padding:12px; border:1px solid #ccc;">₹ ${finalVal.toLocaleString('en-IN')}</td>
  </tr>
</table>

<p style="margin-top:50px; text-align:center; font-size:15px;">
  Payment to be made / was made via RTGS as per above details.<br><br>
  Prepared by: ___________________ &nbsp;&nbsp;&nbsp; 
  Checked by: ___________________ &nbsp;&nbsp;&nbsp; 
  Authorized Signatory: ___________________
</p>`;

  document.getElementById('output').innerHTML = voucherHtml;
  document.getElementById('historyViewer').style.display = 'none';
  window.scrollTo(0, document.getElementById('output').offsetTop - 100);
}

// ────────────────────────────────────────────────
//     SELECT & PRINT OLD ATTACHMENT LETTER
// ────────────────────────────────────────────────
function showOldAttachmentSelector() {
  const allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  if (allDOs.length === 0) {
    return alert("No previous DOs found in history.");
  }

  let html = `
    <h3 style="margin:0 0 15px 0;">Select DO for Attachment Letter</h3>
    <div style="max-height:350px; overflow-y:auto; border:1px solid #ccc; padding:10px; background:#f9f9f9;">
  `;

  allDOs.sort((a,b) => {
    const dateA = a.date.split('/').reverse().join('');
    const dateB = b.date.split('/').reverse().join('');
    return dateB.localeCompare(dateA);
  });

  allDOs.forEach(doItem => {
    if (!doItem.doNumber || !doItem.mdName.trim()) return;
    html += `
      <div style="padding:8px; border-bottom:1px solid #eee; cursor:pointer;"
           onclick="generateOldAttachmentLetter('${doItem.doNumber}')">
        ${doItem.date} • ${doItem.doNumber} • ${doItem.mdName.substring(0,45)}${doItem.mdName.length>45?'...':''}
      </div>
    `;
  });

  html += `</div><br><button onclick="document.getElementById('historyViewer').style.display='none'">Close</button>`;

  document.getElementById('historyList').innerHTML = html;
  document.getElementById('historyViewer').style.display = 'block';
}

function generateOldAttachmentLetter(doNumber) {
  const allDOs = JSON.parse(localStorage.getItem("allDOs") || "[]");
  const doData = allDOs.find(d => d.doNumber === doNumber);
  
  if (!doData) return alert("Selected DO not found.");

  const finalTotal = doData.finalTotal || '0';
  const rtgsNo = doData.rtgsNo || '-';

  document.getElementById('output').innerHTML = `
<div class="header-band">
  <div class="header-row" style="color:#0033cc; margin-bottom:6px; font-size:12px;">
    <div class="header-cell left"><b>GSTN:</b> 27AAYPD2686B1ZI</div>
    <div class="header-cell center">Subject to Kolhapur Jurisdiction</div>
    <div class="header-cell right"><b>FSSAI:</b> 11522042000172</div>
  </div>

  <div class="output-letterhead">M/S P. P. DUNUNG AND COMPANY</div>
  <div class="output-subhead">Wholesale Sugar Dealers, Kolhapur</div>

  <div class="output-contact">
    1529 c ward Laxmipuri, Kolhapur. Phone No. 2642250 / 9271678091<br>
    Email: paragdunung@rediffmail.com
  </div>
</div>

<div class="output-hr"></div>

<table class="no-border" style="margin-bottom:20px;">
  <tr>
    <td></td>
    <td style="text-align:right"><b>दिनांक :</b> ${doData.date}</td>
  </tr>
</table>

<p><b>प्रति,</b><br>
${doData.mdName || '---'}<br>
${doData.mdAddress || '---'}</p>

<p><b>विषय :</b> रक्कम जमा करणेबाबत</p>

<p>महोदय,</p>

<p>आपले खातेवर RTGS Rs. <span class="box">${finalTotal}</span> खालील प्रमाणे जमा केली आहे / करावी.</p>

<p>1) M/S P. P. DUNUNG AND COMPANY KOLHAPUR<br>
<span style="display:inline-block; margin-left:40px;">रक्कम Rs. <span class="box">${finalTotal}</span></span><br>
<span style="display:inline-block; margin-left:40px;">RTGS No. <span class="box">${rtgsNo}</span></span></p>

<p style="margin-top:50px;">Yours faithfully,<br><br>
<div style="position:relative; height:100px;">
  <div style="position:absolute; left:0; bottom:0;">
    <img src="Stamp.png" alt="Company Stamp" style="width:140px; height:auto; opacity:0.9;">
  </div>
</div>
Authorized Signatory</p>`;

  document.getElementById('historyViewer').style.display = 'none';
  window.scrollTo(0, document.getElementById('output').offsetTop - 100);
}

</script>
</body>
</html>
